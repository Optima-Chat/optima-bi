# Optima BI ä¸“å®¶è¯„å®¡æŠ¥å‘Š

> ä» BI ç³»ç»Ÿæœ€ä½³å®è·µè§’åº¦è¯„å®¡ PRDã€æŠ€æœ¯æ–¹æ¡ˆå’Œå¼€å‘è®¡åˆ’

**è¯„å®¡äºº**: BI ç³»ç»Ÿæ¶æ„ä¸“å®¶
**è¯„å®¡æ—¥æœŸ**: 2025-01-21
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

---

## ğŸ“Š è¯„å®¡æ€»ç»“

| ç»´åº¦ | è¯„åˆ† | è¯„ä»· |
|------|------|------|
| **æ¶æ„è®¾è®¡** | âš ï¸ 6/10 | å­˜åœ¨ OLTP/OLAP æ··ç”¨çš„æ€§èƒ½éšæ‚£ |
| **æ•°æ®å»ºæ¨¡** | âš ï¸ 5/10 | ç¼ºå°‘ç»´åº¦å»ºæ¨¡å’Œæ•°æ®èšåˆå±‚ |
| **åˆ†æèƒ½åŠ›** | âœ… 7/10 | AI-Native è®¾è®¡åˆ›æ–°ï¼Œä½†ç¼ºå°‘å¯è§†åŒ– |
| **æ€§èƒ½ä¼˜åŒ–** | âš ï¸ 6/10 | ä»…é ç¼“å­˜ä¸è¶³ä»¥åº”å¯¹å¤æ‚æŸ¥è¯¢ |
| **å¯æ‰©å±•æ€§** | âœ… 8/10 | TypeScript æŠ€æœ¯æ ˆè‰¯å¥½ï¼Œä½†éœ€æ•°æ®å±‚ä¼˜åŒ– |
| **å¼€å‘è®¡åˆ’** | âœ… 8/10 | åˆ†é˜¶æ®µåˆç†ï¼Œä½†ç¼ºå°‘æ€§èƒ½æµ‹è¯•è®¡åˆ’ |
| **ç»¼åˆè¯„åˆ†** | âš ï¸ **6.7/10** | å¯è¡Œä½†éœ€é‡å¤§æ”¹è¿› |

**æ€»ä½“è¯„ä»·**:
- âœ… **åˆ›æ–°ç‚¹**: AI-Native BI æ˜¯å¾ˆå¥½çš„æ–¹å‘
- âš ï¸ **æ ¸å¿ƒé—®é¢˜**: ç¼ºå°‘ OLAP å±‚ï¼Œç›´æ¥æŸ¥è¯¢ OLTP å­˜åœ¨æ€§èƒ½é£é™©
- ğŸ”§ **æ”¹è¿›å»ºè®®**: å¼•å…¥æ•°æ®èšåˆå±‚å’Œç»´åº¦å»ºæ¨¡

---

## ğŸ” è¯¦ç»†è¯„å®¡

### 1. æ¶æ„è®¾è®¡è¯„å®¡

#### å½“å‰æ¶æ„
```
å•†å®¶ â†’ Claude Code â†’ bi-cli â†’ bi-backend â†’ commerce-backend DB (OLTP)
                                          â†“
                                      Redis (5min ç¼“å­˜)
```

#### âŒ æ ¸å¿ƒé—®é¢˜ï¼šOLTP/OLAP æ··ç”¨

**é—®é¢˜æè¿°**:
```sql
-- è¿™ç§å¤æ‚æŸ¥è¯¢ç›´æ¥åœ¨ OLTP æ•°æ®åº“æ‰§è¡Œ
SELECT
  DATE(created_at) as date,
  SUM(amount_total) as revenue,
  COUNT(*) as orders,
  AVG(amount_total) as aov
FROM orders
WHERE merchant_id = 'xxx'
  AND created_at >= NOW() - INTERVAL '90 days'
GROUP BY DATE(created_at);
```

**é—®é¢˜åˆ†æ**:
1. **æ€§èƒ½å½±å“**: OLTP æ•°æ®åº“ä¸»è¦æœåŠ¡ä¸šåŠ¡ç³»ç»Ÿï¼ˆè®¢å•åˆ›å»ºã€æ”¯ä»˜ï¼‰ï¼Œåˆ†ææŸ¥è¯¢ä¼šï¼š
   - å ç”¨å¤§é‡ CPU/å†…å­˜
   - å¯¼è‡´æ…¢æŸ¥è¯¢ï¼Œå½±å“ä¸šåŠ¡æ€§èƒ½
   - é”è¡¨é£é™©ï¼ˆå°¤å…¶æ˜¯å…¨è¡¨æ‰«æï¼‰

2. **æ‰©å±•æ€§å·®**:
   - å•†å®¶æ•°å¢é•¿åï¼ŒæŸ¥è¯¢å‹åŠ›çº¿æ€§å¢é•¿
   - å†å²æ•°æ®æŸ¥è¯¢è¶Šæ¥è¶Šæ…¢
   - æ— æ³•æ”¯æŒå¤æ‚çš„å¤šç»´åˆ†æ

3. **ç¼“å­˜å±€é™**:
   - Redis ç¼“å­˜åªèƒ½ç¼“å­˜å›ºå®šæŸ¥è¯¢
   - è‡ªå®šä¹‰æŸ¥è¯¢æ— æ³•ç¼“å­˜
   - 5 åˆ†é’Ÿ TTL å¤ªçŸ­ï¼Œæ•°æ®å˜åŒ–ä¸å¤§æ—¶æµªè´¹èµ„æº

#### âœ… ä¸šç•Œæœ€ä½³å®è·µï¼šOLTP/OLAP åˆ†ç¦»

**æ ‡å‡† BI æ¶æ„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OLTP æ•°æ®åº“  â”‚ (commerce-backend PostgreSQL)
â”‚ è®¢å•/å•†å“/ç”¨æˆ·â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ ETL (æ¯å°æ—¶/æ¯å¤©)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OLAP æ•°æ®åº“  â”‚ (ClickHouse / TimescaleDB / PostgreSQL)
â”‚ é¢„èšåˆæ•°æ®   â”‚
â”‚ ç»´åº¦å»ºæ¨¡     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BI API     â”‚ (bi-backend)
â”‚  ç¼“å­˜å±‚      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  bi-cli     â”‚ â†’ Claude Code â†’ å•†å®¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜åŠ¿**:
- **æ€§èƒ½éš”ç¦»**: åˆ†ææŸ¥è¯¢ä¸å½±å“ä¸šåŠ¡ç³»ç»Ÿ
- **æŸ¥è¯¢ä¼˜åŒ–**: OLAP æ•°æ®åº“ä¸“ä¸ºåˆ†æä¼˜åŒ–ï¼ˆåˆ—å­˜å‚¨ã€é¢„èšåˆï¼‰
- **å†å²æ•°æ®**: å¯ä¿ç•™æ›´é•¿æ—¶é—´çš„å†å²æ•°æ®
- **å¤æ‚åˆ†æ**: æ”¯æŒå¤šç»´åˆ†æã€åŒæœŸå¯¹æ¯”ã€æ¼æ–—åˆ†æ

#### ğŸ”§ æ”¹è¿›å»ºè®®ï¼ˆå¿…é¡»ï¼‰

**æ–¹æ¡ˆ A: è½»é‡çº§æ”¹è¿›ï¼ˆæ¨è MVPï¼‰**
```sql
-- åœ¨ commerce-backend æ•°æ®åº“åˆ›å»ºé¢„èšåˆè¡¨ï¼ˆç‰©åŒ–è§†å›¾ï¼‰
CREATE MATERIALIZED VIEW daily_sales_summary AS
SELECT
  merchant_id,
  DATE(created_at) as date,
  COUNT(*) as order_count,
  SUM(amount_total) as total_revenue,
  AVG(amount_total) as avg_order_value,
  COUNT(DISTINCT customer_email) as unique_customers
FROM orders
WHERE status IN ('paid', 'delivered')
GROUP BY merchant_id, DATE(created_at);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_daily_sales_merchant_date
ON daily_sales_summary(merchant_id, date);

-- æ¯å°æ—¶åˆ·æ–°ä¸€æ¬¡
REFRESH MATERIALIZED VIEW CONCURRENTLY daily_sales_summary;
```

**ä¼˜åŠ¿**:
- ä¸éœ€è¦ç‹¬ç«‹æ•°æ®åº“
- æŸ¥è¯¢é€Ÿåº¦æå‡ 10-100 å€
- å‡å°‘ OLTP è´Ÿè½½
- å®æ–½æˆæœ¬ä½

**æ–¹æ¡ˆ B: ç‹¬ç«‹ OLAP æ•°æ®åº“ï¼ˆé•¿æœŸï¼‰**
```
1. é€‰æ‹© OLAP æ•°æ®åº“
   - ClickHouse (æ¨è): åˆ—å­˜å‚¨ï¼ŒæŸ¥è¯¢æå¿«
   - TimescaleDB: PostgreSQL æ‰©å±•ï¼Œæ—¶åºæ•°æ®ä¼˜åŒ–
   - PostgreSQL: å¤ç”¨ç°æœ‰æŠ€æœ¯æ ˆ

2. ETL æµç¨‹
   - æ¯å°æ—¶åŒæ­¥å¢é‡æ•°æ®
   - ä½¿ç”¨ Airbyte / Debezium CDC
   - é¢„èšåˆå¤šä¸ªç²’åº¦ï¼ˆå°æ—¶/å¤©/å‘¨/æœˆï¼‰

3. ç»´åº¦å»ºæ¨¡
   - äº‹å®è¡¨ï¼šorders_fact, order_items_fact
   - ç»´åº¦è¡¨ï¼šdim_merchant, dim_product, dim_time
```

---

### 2. æ•°æ®å»ºæ¨¡è¯„å®¡

#### âŒ å½“å‰é—®é¢˜ï¼šç¼ºå°‘ç»´åº¦å»ºæ¨¡

**å½“å‰è®¾è®¡**:
- ç›´æ¥æŸ¥è¯¢ä¸šåŠ¡è¡¨ï¼ˆorders, products, merchantsï¼‰
- æ²¡æœ‰ç»´åº¦è¡¨å’Œäº‹å®è¡¨çš„åŒºåˆ†
- æ²¡æœ‰é¢„èšåˆ
- æ²¡æœ‰æ—¶é—´ç»´åº¦è¡¨

**é—®é¢˜**:
1. **æŸ¥è¯¢å¤æ‚**: æ¯æ¬¡éƒ½è¦ JOIN å¤šä¸ªè¡¨
2. **æ€§èƒ½å·®**: æ²¡æœ‰é¢„è®¡ç®—ï¼Œå®æ—¶èšåˆæ…¢
3. **éš¾ä»¥æ‰©å±•**: æ— æ³•æ”¯æŒå¤æ‚çš„å¤šç»´åˆ†æ

#### âœ… ä¸šç•Œæœ€ä½³å®è·µï¼šKimball ç»´åº¦å»ºæ¨¡

**æ˜Ÿå‹æ¨¡å‹ç¤ºä¾‹**:
```sql
-- äº‹å®è¡¨ï¼šè®¢å•äº‹å®
CREATE TABLE fact_orders (
  order_id UUID PRIMARY KEY,
  merchant_id UUID,          -- ç»´åº¦å¤–é”®
  product_id UUID,           -- ç»´åº¦å¤–é”®
  customer_id UUID,          -- ç»´åº¦å¤–é”®
  time_id INT,               -- ç»´åº¦å¤–é”®

  -- åº¦é‡å€¼ï¼ˆMeasuresï¼‰
  order_amount DECIMAL(10, 2),
  quantity INT,
  shipping_fee DECIMAL(10, 2),

  -- é€€åŒ–ç»´åº¦ï¼ˆDegenerate Dimensionsï¼‰
  order_number VARCHAR(50),
  status VARCHAR(20)
);

-- ç»´åº¦è¡¨ï¼šæ—¶é—´ç»´åº¦
CREATE TABLE dim_time (
  time_id INT PRIMARY KEY,   -- 20240121
  date DATE,
  year INT,
  quarter INT,
  month INT,
  week INT,
  day_of_week INT,
  is_weekend BOOLEAN,
  is_holiday BOOLEAN
);

-- ç»´åº¦è¡¨ï¼šå•†æˆ·ç»´åº¦
CREATE TABLE dim_merchant (
  merchant_id UUID PRIMARY KEY,
  merchant_name VARCHAR(255),
  category VARCHAR(100),
  tier VARCHAR(20),          -- free/pro/enterprise
  created_date DATE,
  country VARCHAR(2)
);

-- ç»´åº¦è¡¨ï¼šå•†å“ç»´åº¦
CREATE TABLE dim_product (
  product_id UUID PRIMARY KEY,
  product_name VARCHAR(255),
  category VARCHAR(100),
  brand VARCHAR(100),
  price_range VARCHAR(20)    -- 0-50, 50-100, 100+
);
```

**æŸ¥è¯¢ç¤ºä¾‹ï¼ˆä¼˜åŒ–åï¼‰**:
```sql
-- æŸ¥è¯¢æŸå•†å®¶æœ€è¿‘ 30 å¤©çš„é”€å”®è¶‹åŠ¿ï¼ˆä½¿ç”¨æ˜Ÿå‹æ¨¡å‹ï¼‰
SELECT
  t.date,
  t.day_of_week,
  SUM(f.order_amount) as revenue,
  COUNT(*) as orders
FROM fact_orders f
JOIN dim_time t ON f.time_id = t.time_id
WHERE f.merchant_id = 'merchant_xxx'
  AND t.date >= CURRENT_DATE - INTERVAL '30 days'
GROUP BY t.date, t.day_of_week
ORDER BY t.date;

-- æ€§èƒ½å¯¹æ¯”
-- å½“å‰æ–¹æ¡ˆ: 2-5 ç§’ï¼ˆå…¨è¡¨æ‰«æ + å®æ—¶èšåˆï¼‰
-- æ˜Ÿå‹æ¨¡å‹: 50-200 æ¯«ç§’ï¼ˆç´¢å¼•æŸ¥è¯¢ + é¢„èšåˆï¼‰
```

#### ğŸ”§ æ”¹è¿›å»ºè®®ï¼ˆæ¨èï¼‰

**æœ€å°æ”¹è¿›ï¼ˆMVP å¯è¡Œï¼‰**:
```sql
-- åˆ›å»ºæŒ‰æ—¥èšåˆçš„æ±‡æ€»è¡¨
CREATE TABLE daily_merchant_summary (
  merchant_id UUID,
  date DATE,

  -- é”€å”®æŒ‡æ ‡
  total_revenue DECIMAL(10, 2),
  order_count INT,
  avg_order_value DECIMAL(10, 2),

  -- å®¢æˆ·æŒ‡æ ‡
  unique_customers INT,
  new_customers INT,
  repeat_customers INT,

  -- å•†å“æŒ‡æ ‡
  products_sold INT,
  avg_items_per_order DECIMAL(5, 2),

  PRIMARY KEY (merchant_id, date)
);

-- æ¯å¤©å‡Œæ™¨é€šè¿‡ ETL æ›´æ–°å‰ä¸€å¤©çš„æ•°æ®
-- æŸ¥è¯¢æ—¶ç›´æ¥è¯»å–æ±‡æ€»è¡¨ï¼Œé€Ÿåº¦æå‡ 100 å€
```

---

### 3. åˆ†æèƒ½åŠ›è¯„å®¡

#### âœ… åˆ›æ–°ç‚¹ï¼šAI-Native BI

**ä¼˜åŠ¿**:
1. **è‡ªç„¶è¯­è¨€æŸ¥è¯¢**: å•†å®¶æ— éœ€å­¦ä¹  SQL æˆ–æ‹–æ‹½å¼å·¥å…·
2. **æ™ºèƒ½æ´å¯Ÿ**: Claude Code å¯ä»¥ç”Ÿæˆæ´å¯Ÿå’Œå»ºè®®
3. **å¯¹è¯å¼ä½“éªŒ**: ç¬¦åˆ LLM æ—¶ä»£çš„äº¤äº’æ¨¡å¼

**æ¡ˆä¾‹**:
```
å•†å®¶: "ä¸ºä»€ä¹ˆè¿™ä¸ªæœˆé”€å”®é¢ä¸‹é™äº†ï¼Ÿ"
Claude Code:
1. è°ƒç”¨ bi-cli sales get --days 30
2. å¯¹æ¯”ä¸Šæœˆæ•°æ®
3. åˆ†æä¸‹é™åŸå› ï¼ˆå®¢å•ä»·ä¸‹é™ / è®¢å•é‡å‡å°‘ï¼‰
4. ç»™å‡ºå»ºè®®ï¼ˆä¿ƒé”€æ´»åŠ¨ / åº“å­˜è¡¥è´§ï¼‰
```

#### âŒ ç¼ºå¤±ï¼šå¯è§†åŒ–èƒ½åŠ›

**é—®é¢˜**:
1. **çº¯æ–‡æœ¬è¾“å‡º**: ç¼ºå°‘å›¾è¡¨ï¼Œæ•°æ®éš¾ä»¥ç†è§£
2. **æ— æ³•å¯¼å‡º**: ä¸æ”¯æŒ Excel/PDF æŠ¥å‘Š
3. **æ— æ³•åˆ†äº«**: ç®¡ç†å±‚æ— æ³•æŸ¥çœ‹å¯è§†åŒ–æŠ¥è¡¨

**å¯¹æ¯”å…¶ä»– BI å·¥å…·**:
| åŠŸèƒ½ | Optima BI | Metabase | Tableau |
|------|-----------|----------|---------|
| è‡ªç„¶è¯­è¨€æŸ¥è¯¢ | âœ… | âš ï¸ åŸºç¡€ | âœ… |
| å¯è§†åŒ–å›¾è¡¨ | âŒ | âœ… | âœ… |
| è‡ªå®šä¹‰æŠ¥è¡¨ | âŒ | âœ… | âœ… |
| æ•°æ®å¯¼å‡º | âŒ | âœ… | âœ… |
| è‡ªåŠ©å¼åˆ†æ | âš ï¸ å—é™ | âœ… | âœ… |

#### ğŸ”§ æ”¹è¿›å»ºè®®ï¼ˆå»ºè®®ï¼‰

**æ–¹æ¡ˆ 1: bi-cli æ”¯æŒå›¾è¡¨è¾“å‡º**
```bash
bi-cli sales get --days 30 --chart line
# è¾“å‡º ASCII å›¾è¡¨æˆ–ä¿å­˜ä¸º PNG

     Sales Trend (Last 30 Days)

50K â”¤         â•­â•®
40K â”¤      â•­â”€â”€â•¯â•°â•®
30K â”¤   â•­â”€â”€â•¯    â•°â•®
20K â”¤â•­â”€â”€â•¯        â•°â”€â•®
10K â”¼â•¯             â•°â”€
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Jan 1        Jan 30
```

**æ–¹æ¡ˆ 2: Web Dashboardï¼ˆPhase 2ï¼‰**
```
åˆ›å»ºç®€å•çš„ Web ç•Œé¢ï¼ˆNext.jsï¼‰
- æŸ¥çœ‹é¢„å®šä¹‰çš„æŠ¥è¡¨
- å¯¼å‡º PDF/Excel
- ä¸å›¢é˜Ÿåˆ†äº«
```

**æ–¹æ¡ˆ 3: é›†æˆç°æœ‰ BI å·¥å…·**
```
æä¾› API æ¥å£ç»™ Metabase/Superset
- bi-backend æš´éœ²æ ‡å‡† SQL æ¥å£
- å•†å®¶å¯ä½¿ç”¨å¯è§†åŒ–å·¥å…·è‡ªåŠ©åˆ†æ
```

---

### 4. æ€§èƒ½ä¼˜åŒ–è¯„å®¡

#### âš ï¸ å½“å‰æ–¹æ¡ˆçš„æ€§èƒ½é—®é¢˜

**é—®é¢˜ 1: ç¼“å­˜ç­–ç•¥è¿‡äºç®€å•**
```typescript
// å½“å‰è®¾è®¡ï¼šç®€å•çš„ 5 åˆ†é’Ÿç¼“å­˜
const cacheKey = `bi:${merchantId}:sales:7d`;
const cached = await redis.get(cacheKey);
if (cached) return cached;

// æŸ¥è¯¢æ•°æ®åº“
const data = await prisma.order.findMany(...);
await redis.set(cacheKey, data, 'EX', 300);
```

**é—®é¢˜**:
- ç¼“å­˜ç²’åº¦å¤ªç²—ï¼šä¸åŒå‚æ•°ï¼ˆdays=7 vs days=30ï¼‰æ— æ³•å¤ç”¨
- TTL å›ºå®šï¼šæ•°æ®å˜åŒ–é¢‘ç‡ä¸åŒï¼ŒTTL åº”è¯¥ä¸åŒ
- ç¼“å­˜é¢„çƒ­ï¼šå†·å¯åŠ¨æ—¶æ€§èƒ½å·®

**é—®é¢˜ 2: æ²¡æœ‰æŸ¥è¯¢ä¼˜åŒ–**
- æ²¡æœ‰ EXPLAIN åˆ†æ
- æ²¡æœ‰æ…¢æŸ¥è¯¢ç›‘æ§
- æ²¡æœ‰æŸ¥è¯¢è®¡åˆ’ä¼˜åŒ–

**é—®é¢˜ 3: æ²¡æœ‰å¹¶å‘æ§åˆ¶**
- ç¼“å­˜å‡»ç©¿ï¼šé«˜å¹¶å‘æ—¶å¤šä¸ªè¯·æ±‚åŒæ—¶æŸ¥è¯¢æ•°æ®åº“
- ç¼“å­˜é›ªå´©ï¼šå¤§é‡ç¼“å­˜åŒæ—¶è¿‡æœŸ

#### âœ… ä¸šç•Œæœ€ä½³å®è·µ

**å¤šå±‚ç¼“å­˜ç­–ç•¥**:
```typescript
// L1: å†…å­˜ç¼“å­˜ï¼ˆ1 åˆ†é’Ÿï¼‰- æçƒ­æ•°æ®
const memCache = new NodeCache({ stdTTL: 60 });

// L2: Redis ç¼“å­˜ï¼ˆ5 åˆ†é’Ÿï¼‰- çƒ­æ•°æ®
// L3: é¢„èšåˆè¡¨ï¼ˆå®æ—¶ï¼‰- æ¸©æ•°æ®
// L4: å†å²æ•°æ®å½’æ¡£ï¼ˆå¤©çº§ï¼‰- å†·æ•°æ®

async function getSalesData(merchantId: string, days: number) {
  // L1 å†…å­˜ç¼“å­˜
  const l1Key = `sales:${merchantId}:${days}`;
  let data = memCache.get(l1Key);
  if (data) return data;

  // L2 Redis ç¼“å­˜
  const l2Key = `bi:sales:${merchantId}:${days}`;
  data = await redis.get(l2Key);
  if (data) {
    memCache.set(l1Key, data);
    return data;
  }

  // L3 æŸ¥è¯¢é¢„èšåˆè¡¨ï¼ˆè€ŒéåŸå§‹è¡¨ï¼‰
  data = await queryDailySummaryTable(merchantId, days);

  // å†™å…¥ç¼“å­˜
  await redis.set(l2Key, data, 'EX', 300);
  memCache.set(l1Key, data);

  return data;
}
```

**æŸ¥è¯¢ä¼˜åŒ–**:
```sql
-- 1. åˆ›å»ºåˆé€‚çš„ç´¢å¼•
CREATE INDEX idx_orders_merchant_created_status
ON orders(merchant_id, created_at, status)
WHERE status IN ('paid', 'delivered');

-- 2. ä½¿ç”¨ EXPLAIN åˆ†æ
EXPLAIN ANALYZE
SELECT * FROM orders
WHERE merchant_id = 'xxx'
  AND created_at >= NOW() - INTERVAL '7 days';

-- 3. é¿å… SELECT *
SELECT id, amount_total, created_at -- åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
FROM orders;

-- 4. ä½¿ç”¨é¢„èšåˆè¡¨
SELECT * FROM daily_merchant_summary
WHERE merchant_id = 'xxx' AND date >= CURRENT_DATE - 7;
```

**å¹¶å‘æ§åˆ¶**:
```typescript
// é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼šä½¿ç”¨åˆ†å¸ƒå¼é”
async function getSalesDataWithLock(merchantId: string) {
  const lockKey = `lock:sales:${merchantId}`;
  const lock = await redis.set(lockKey, '1', 'EX', 10, 'NX');

  if (lock) {
    // è·å–é”æˆåŠŸï¼ŒæŸ¥è¯¢æ•°æ®åº“
    const data = await queryDatabase(merchantId);
    await redis.set(cacheKey, data, 'EX', 300);
    await redis.del(lockKey);
    return data;
  } else {
    // è·å–é”å¤±è´¥ï¼Œç­‰å¾…åé‡è¯•
    await sleep(100);
    return getSalesData(merchantId);
  }
}
```

#### ğŸ”§ æ”¹è¿›å»ºè®®ï¼ˆå¿…é¡»ï¼‰

1. **å¼•å…¥é¢„èšåˆè¡¨**ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
2. **å¤šå±‚ç¼“å­˜ç­–ç•¥**
3. **æŸ¥è¯¢ä¼˜åŒ–å’Œç´¢å¼•**
4. **å¹¶å‘æ§åˆ¶ï¼ˆåˆ†å¸ƒå¼é”ï¼‰**
5. **æ…¢æŸ¥è¯¢ç›‘æ§å’Œå‘Šè­¦**

---

### 5. å¯æ‰©å±•æ€§è¯„å®¡

#### âœ… æŠ€æœ¯æ ˆé€‰æ‹©åˆç†

**ä¼˜åŠ¿**:
- TypeScript ç±»å‹å®‰å…¨
- Fastify é«˜æ€§èƒ½
- Prisma ORM ç±»å‹å‹å¥½
- Redis ç¼“å­˜æˆç†Ÿ

#### âš ï¸ æ•°æ®å±‚æ‰©å±•æ€§ä¸è¶³

**é—®é¢˜**:
1. **å•ç‚¹æ•°æ®åº“**: æ‰€æœ‰æŸ¥è¯¢éƒ½æ‰“åˆ° commerce-backend PostgreSQL
2. **æ— è¯»å†™åˆ†ç¦»**: æ²¡æœ‰ä»åº“åˆ†æ‹…è¯»å‹åŠ›
3. **æ— åˆ†åº“åˆ†è¡¨**: å•†å®¶æ•°å¢é•¿åæ€§èƒ½ä¸‹é™

#### ğŸ”§ æ”¹è¿›å»ºè®®ï¼ˆé•¿æœŸï¼‰

**Phase 1: è¯»å†™åˆ†ç¦»**
```
å•†å®¶ â†’ bi-backend â†’ PostgreSQL ä»åº“ï¼ˆåªè¯»ï¼‰
                    â†“
                 Redis ç¼“å­˜
```

**Phase 2: å‚ç›´æ‹†åˆ†**
```
bi-backend â†’ OLAP æ•°æ®åº“ï¼ˆClickHouseï¼‰
           â†’ Redis ç¼“å­˜
```

**Phase 3: æ°´å¹³æ‹†åˆ†**
```
bi-backend â†’ æŒ‰å•†å®¶åˆ†åº“
           â†’ merchant_0001 æ•°æ®åº“
           â†’ merchant_0002 æ•°æ®åº“
```

---

### 6. å¼€å‘è®¡åˆ’è¯„å®¡

#### âœ… åˆ†é˜¶æ®µåˆç†

**ä¼˜åŠ¿**:
- MVP ä¼˜å…ˆï¼Œå¿«é€ŸéªŒè¯
- é‡Œç¨‹ç¢‘æ¸…æ™°
- å·¥ä½œé‡è¯„ä¼°åˆç†ï¼ˆ6-7 å‘¨ï¼‰

#### âš ï¸ ç¼ºå¤±ï¼šæ€§èƒ½æµ‹è¯•è®¡åˆ’

**é—®é¢˜**:
1. **æ²¡æœ‰æ€§èƒ½åŸºå‡†**: æ²¡æœ‰å®šä¹‰ "API å“åº” < 2s" çš„æµ‹è¯•åœºæ™¯
2. **æ²¡æœ‰å‹æµ‹è®¡åˆ’**: æ²¡æœ‰å¹¶å‘æµ‹è¯•
3. **æ²¡æœ‰æ•°æ®è§„æ¨¡æµ‹è¯•**: æ²¡æœ‰å¤§æ•°æ®é‡æµ‹è¯•ï¼ˆç™¾ä¸‡è®¢å•ï¼‰

#### ğŸ”§ æ”¹è¿›å»ºè®®ï¼ˆå¿…é¡»ï¼‰

**æ·»åŠ  Phase 1.5: æ€§èƒ½æµ‹è¯•å‘¨**
```
Week 3.5: æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

1. æ€§èƒ½åŸºå‡†æµ‹è¯•
   - å•å•†å®¶ 100 ä¸‡è®¢å•
   - å¹¶å‘ 100 QPS
   - å“åº”æ—¶é—´ P50 < 500ms, P99 < 2s

2. å‹åŠ›æµ‹è¯•
   - 1000 ä¸ªå•†å®¶åŒæ—¶æŸ¥è¯¢
   - ç¼“å­˜å¤±æ•ˆåœºæ™¯
   - æ•°æ®åº“è¿æ¥æ± è€—å°½åœºæ™¯

3. æ•°æ®åº“ä¼˜åŒ–
   - æ…¢æŸ¥è¯¢åˆ†æ
   - ç´¢å¼•ä¼˜åŒ–
   - æŸ¥è¯¢æ”¹å†™

4. ç¼“å­˜ä¼˜åŒ–
   - ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§
   - ç¼“å­˜é¢„çƒ­
   - ç¼“å­˜ç©¿é€ä¿æŠ¤
```

---

## ğŸ“‹ æ”¹è¿›ä¼˜å…ˆçº§

### ğŸ”´ å¿…é¡»æ”¹è¿›ï¼ˆP0 - MVP é˜¶æ®µï¼‰

| é—®é¢˜ | å½±å“ | æ”¹è¿›æ–¹æ¡ˆ | å·¥ä½œé‡ |
|------|------|---------|--------|
| OLTP/OLAP æ··ç”¨ | ä¸¥é‡æ€§èƒ½é—®é¢˜ | åˆ›å»ºé¢„èšåˆè¡¨ï¼ˆç‰©åŒ–è§†å›¾ï¼‰ | 3-5 å¤© |
| ç¼ºå°‘ç´¢å¼• | æŸ¥è¯¢æ…¢ | æ·»åŠ å¿…è¦ç´¢å¼• | 1 å¤© |
| ç¼“å­˜ç­–ç•¥ç®€å• | æ€§èƒ½ä¸ç¨³å®š | å¤šå±‚ç¼“å­˜ + åˆ†å¸ƒå¼é” | 2-3 å¤© |
| æ²¡æœ‰æ€§èƒ½æµ‹è¯• | ä¸Šçº¿é£é™© | æ·»åŠ å‹æµ‹å’ŒåŸºå‡†æµ‹è¯• | 3 å¤© |

**æ€»è®¡**: 9-12 å¤©ï¼ˆçº¦ 2 å‘¨ï¼‰

### ğŸŸ¡ å»ºè®®æ”¹è¿›ï¼ˆP1 - Phase 2ï¼‰

| é—®é¢˜ | å½±å“ | æ”¹è¿›æ–¹æ¡ˆ | å·¥ä½œé‡ |
|------|------|---------|--------|
| ç¼ºå°‘å¯è§†åŒ– | ç”¨æˆ·ä½“éªŒå·® | æ·»åŠ  ASCII å›¾è¡¨æˆ–ç®€å• Web ç•Œé¢ | 3-5 å¤© |
| ç¼ºå°‘ç»´åº¦å»ºæ¨¡ | æŸ¥è¯¢å¤æ‚ | è®¾è®¡æ˜Ÿå‹æ¨¡å‹ï¼ˆæ¸è¿›å¼ï¼‰ | 5-7 å¤© |
| ç¼ºå°‘æ•°æ®å¯¼å‡º | åŠŸèƒ½ä¸å®Œæ•´ | æ”¯æŒ CSV/Excel å¯¼å‡º | 2 å¤© |

**æ€»è®¡**: 10-14 å¤©ï¼ˆçº¦ 2 å‘¨ï¼‰

### ğŸŸ¢ é•¿æœŸä¼˜åŒ–ï¼ˆP2 - Phase 3+ï¼‰

| é—®é¢˜ | å½±å“ | æ”¹è¿›æ–¹æ¡ˆ | å·¥ä½œé‡ |
|------|------|---------|--------|
| ç‹¬ç«‹ OLAP æ•°æ®åº“ | æ€§èƒ½å’Œæ‰©å±•æ€§ | å¼•å…¥ ClickHouse | 2-3 å‘¨ |
| BI å·¥å…·é›†æˆ | åŠŸèƒ½å®Œæ•´æ€§ | Metabase / Superset | 1-2 å‘¨ |
| å®æ—¶æ•°æ®æµ | æ•°æ®æ—¶æ•ˆæ€§ | Kafka + Flink CDC | 3-4 å‘¨ |

---

## ğŸ¯ ä¿®è®¢åçš„æ¶æ„å»ºè®®

### MVP æ¶æ„ï¼ˆPhase 1 - ä¿®è®¢ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Claude Code  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚   bi-cli     â”‚ (TypeScript CLI)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   bi-backend (Fastify)        â”‚
â”‚   - è®¤è¯ä¸­é—´ä»¶                 â”‚
â”‚   - åˆ†å¸ƒå¼é”                   â”‚
â”‚   - å¤šå±‚ç¼“å­˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â–º Redis L2 ç¼“å­˜ (5min)
       â”‚
       â””â”€â–º PostgreSQL (åªè¯»)
           â”œâ”€â–º é¢„èšåˆè¡¨ï¼ˆæ–°å¢ï¼‰
           â”‚   - daily_merchant_summary
           â”‚   - weekly_product_summary
           â”‚   - monthly_customer_summary
           â”‚
           â””â”€â–º åŸå§‹è¡¨ï¼ˆå¿…è¦æ—¶æŸ¥è¯¢ï¼‰
               - orders
               - order_items
               - products
```

**å…³é”®æ”¹è¿›**:
1. âœ… **é¢„èšåˆè¡¨**: è§£å†³ OLTP/OLAP æ··ç”¨é—®é¢˜
2. âœ… **å¤šå±‚ç¼“å­˜**: å†…å­˜ + Redis ä¸¤å±‚ç¼“å­˜
3. âœ… **åˆ†å¸ƒå¼é”**: é˜²æ­¢ç¼“å­˜å‡»ç©¿
4. âœ… **å¿…è¦ç´¢å¼•**: ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

### é•¿æœŸæ¶æ„ï¼ˆPhase 3+ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Claude Code  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚   bi-cli     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   bi-backend                  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                  â”‚
    â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Redis    â”‚    â”‚ ClickHouse   â”‚ (OLAP)
â”‚  ç¼“å­˜      â”‚    â”‚ é¢„èšåˆæ•°æ®    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ ç»´åº¦å»ºæ¨¡      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ ETL (æ¯å°æ—¶)
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                 â”‚ PostgreSQL   â”‚ (OLTP)
                 â”‚ commerce-backend
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ä¿®è®¢åçš„æ—¶é—´çº¿

| é˜¶æ®µ | åŸè®¡åˆ’ | ä¿®è®¢å | å˜åŒ– |
|------|--------|--------|------|
| Phase 0 | 1 å‘¨ | 1 å‘¨ | - |
| Phase 1 | 2-3 å‘¨ | **3-4 å‘¨** | +1 å‘¨ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰ |
| Phase 2 | 2 å‘¨ | 2-3 å‘¨ | +1 å‘¨ï¼ˆå¯è§†åŒ–ï¼‰ |
| Phase 3 | 1 å‘¨ | 1-2 å‘¨ | +1 å‘¨ï¼ˆå‹æµ‹ï¼‰ |
| **æ€»è®¡** | **6-7 å‘¨** | **7-10 å‘¨** | **+1-3 å‘¨** |

**æ–°å¢å·¥ä½œ**:
- Week 2.5: åˆ›å»ºé¢„èšåˆè¡¨å’Œ ETL è„šæœ¬
- Week 3.5: æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- Week 5.5: æ·»åŠ å¯è§†åŒ–èƒ½åŠ›ï¼ˆå¯é€‰ï¼‰

---

## âœ… æœ€ç»ˆè¯„å®¡ç»“è®º

### å½“å‰æ–¹æ¡ˆè¯„åˆ†ï¼š6.7/10

**å¯è¡Œæ€§**: âœ… å¯ä»¥å®æ–½
**é£é™©ç­‰çº§**: âš ï¸ ä¸­ç­‰é£é™©
**æ¨èå†³ç­–**: ğŸ”§ éœ€è¦é‡å¤§æ”¹è¿›åå†å®æ–½

### å…³é”®å»ºè®®

1. **å¿…é¡»åš**ï¼ˆMVP ä¹‹å‰ï¼‰:
   - âœ… åˆ›å»ºé¢„èšåˆè¡¨ï¼ˆdaily_merchant_summaryï¼‰
   - âœ… æ·»åŠ æ•°æ®åº“ç´¢å¼•
   - âœ… å®ç°å¤šå±‚ç¼“å­˜å’Œåˆ†å¸ƒå¼é”
   - âœ… æ·»åŠ æ€§èƒ½æµ‹è¯•

2. **å»ºè®®åš**ï¼ˆPhase 2ï¼‰:
   - ğŸŸ¡ æ·»åŠ åŸºç¡€å¯è§†åŒ–èƒ½åŠ›
   - ğŸŸ¡ å®ç°ç»´åº¦å»ºæ¨¡ï¼ˆæ¸è¿›å¼ï¼‰
   - ğŸŸ¡ æ”¯æŒæ•°æ®å¯¼å‡º

3. **é•¿æœŸåš**ï¼ˆPhase 3+ï¼‰:
   - ğŸŸ¢ å¼•å…¥ç‹¬ç«‹ OLAP æ•°æ®åº“ï¼ˆClickHouseï¼‰
   - ğŸŸ¢ é›†æˆ BI å·¥å…·ï¼ˆMetabaseï¼‰
   - ğŸŸ¢ å®æ—¶æ•°æ®æµï¼ˆKafka + Flinkï¼‰

### è¯„å®¡äººç­¾å

**BI ç³»ç»Ÿæ¶æ„ä¸“å®¶**
æ—¥æœŸ: 2025-01-21

---

## ğŸ“š å‚è€ƒèµ„æ–™

1. **ã€ŠThe Data Warehouse Toolkitã€‹** - Ralph Kimballï¼ˆç»´åº¦å»ºæ¨¡åœ£ç»ï¼‰
2. **ã€ŠDesigning Data-Intensive Applicationsã€‹** - Martin Kleppmann
3. **ClickHouse å®˜æ–¹æ–‡æ¡£** - OLAP æ•°æ®åº“æœ€ä½³å®è·µ
4. **Looker LookML** - ç°ä»£ BI å·¥å…·çš„æ•°æ®å»ºæ¨¡è¯­è¨€
5. **dbt (data build tool)** - SQL-first çš„æ•°æ®è½¬æ¢å·¥å…·

---

**æŠ¥å‘Šç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-01-21
