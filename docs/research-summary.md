# Optima BI - ç ”ç©¶æ€»ç»“

> æœ¬æ–‡æ¡£æ€»ç»“äº†å¯¹ Optima Commerce ç”Ÿæ€ç³»ç»Ÿçš„ç ”ç©¶å‘ç°ï¼Œä»¥åŠå¯¹ optima-bi è®¾è®¡çš„å…³é”®å½±å“

**æœ€åæ›´æ–°**: 2025-01-21

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### ä»“åº“ç ”ç©¶
- [commerce-backend](./repos/commerce-backend.md) - å•†å®¶åç«¯ç³»ç»Ÿï¼ˆPython/FastAPIï¼‰
- [user-auth](./repos/user-auth.md) - è®¤è¯æœåŠ¡ï¼ˆOAuth 2.0ï¼‰
- [commerce-cli](./repos/commerce-cli.md) - CLI å‚è€ƒå®ç°ï¼ˆTypeScriptï¼‰
- [optima-store](./repos/optima-store.md) - å‰ç«¯åº—é“ºï¼ˆNext.jsï¼‰

### æŠ€æœ¯å‚è€ƒ
- [API å‚è€ƒæ–‡æ¡£](./api-reference.md) - æ‰€æœ‰å¤–éƒ¨ API æ¥å£
- [æ•°æ®æ¨¡å‹](./data-models.md) - æ•°æ®åº“è¡¨ç»“æ„å’Œ Prisma schema

### æ¶æ„å†³ç­–
- [ADR ç´¢å¼•](./architecture/adr-index.md) - æ‰€æœ‰æ¶æ„å†³ç­–è®°å½•
- [ADR-001: TypeScript æŠ€æœ¯æ ˆ](./architecture/adr-001-typescript-stack.md) âœ…
- [ADR-002: ç›´æ¥æ•°æ®åº“è®¿é—®](./architecture/adr-002-direct-db-access.md) âš ï¸ éœ€æ”¹è¿›
- [ADR-003: OAuth Device Flow](./architecture/adr-003-oauth-device-flow.md) âœ…
- [ADR-004: JSON è¾“å‡º](./architecture/adr-004-json-output.md) âœ…
- [ADR-005: å¤šç¯å¢ƒæ”¯æŒ](./architecture/adr-005-multi-env.md) âœ…
- [ADR-006: é¢„èšåˆè¡¨](./architecture/adr-006-materialized-views.md) ğŸ”´ å¿…é¡»é‡‡çº³

### æ€§èƒ½ä¼˜åŒ–
- [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](./performance-optimization.md) - åŸºäºä¸“å®¶è¯„å®¡çš„ä¼˜åŒ–å»ºè®®
- [ä¸“å®¶è¯„å®¡æŠ¥å‘Š](./expert-review.md) - å®Œæ•´è¯„å®¡ç»“æœï¼ˆ6.7/10ï¼‰

---

## ğŸ¯ ç ”ç©¶ç»“è®º

### 1. æŠ€æœ¯æ ˆé€‰æ‹©

| ç»„ä»¶ | æŠ€æœ¯æ ˆ | ç†ç”± |
|------|--------|------|
| **bi-backend** | TypeScript + Fastify + Prisma | ç±»å‹å®‰å…¨ã€æ€§èƒ½ä¼˜ç§€ã€ç»Ÿä¸€å‰åç«¯ |
| **bi-cli** | TypeScript + Commander.js | å‚è€ƒ commerce-cliã€Device Flow è®¤è¯ |
| **æ•°æ®è®¿é—®** | PostgreSQLï¼ˆåªè¯»ï¼‰ + é¢„èšåˆè¡¨ | æ€§èƒ½ä¼˜åŒ–ã€é¿å… OLTP/OLAP æ··ç”¨ |
| **ç¼“å­˜** | Redisï¼ˆå¤šå±‚ï¼‰ + å†…å­˜ç¼“å­˜ | L1(1åˆ†é’Ÿ) + L2(5åˆ†é’Ÿ) |

**å…³é”®å†³ç­–**: ä½¿ç”¨ TypeScript è€Œé Pythonï¼ˆ[ADR-001](./architecture/adr-001-typescript-stack.md)ï¼‰

---

### 2. è®¤è¯ä½“ç³»

**æ–¹æ¡ˆ**: OAuth 2.0 Device Flowï¼ˆ[ADR-003](./architecture/adr-003-oauth-device-flow.md)ï¼‰

**æµç¨‹**:
```
1. CLI è¯·æ±‚ Device Code
2. ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­æˆæƒ
3. CLI è½®è¯¢è·å– Access Token
4. åŠ å¯†å­˜å‚¨åˆ°æœ¬åœ° (~/.optima/bi-cli/)
```

**è®¤è¯ç«¯ç‚¹**:
- Production: `https://auth.optima.shop`
- Stage: `https://auth-stage.optima.shop`
- Development: `https://auth.optima.chat`

**Token éªŒè¯**: bi-backend è°ƒç”¨ `POST /api/v1/auth/verify`

---

### 3. æ•°æ®æ¨¡å‹

**æ ¸å¿ƒè¡¨**ï¼ˆè¯¦è§ [æ•°æ®æ¨¡å‹æ–‡æ¡£](./data-models.md)ï¼‰:
- `orders` - è®¢å•ä¸»è¡¨ï¼ˆ13 ä¸ªçŠ¶æ€ï¼‰
- `order_items` - è®¢å•æ˜ç»†
- `products` - å•†å“ä¸»è¡¨
- `merchants` - å•†å®¶ä¸»è¡¨
- `merchant_transfers` - è½¬è´¦è®°å½•
- `subscriptions` - è®¢é˜…ç®¡ç†
- `reviews` - å•†å“è¯„ä»·

**æ•°æ®éš”ç¦»**: é€šè¿‡ `merchant_id` å®ç°å•†å®¶æ•°æ®éš”ç¦»

**Prisma ç”Ÿæˆ**:
```bash
npx prisma db pull --url="postgresql://readonly_user:pass@host:5432/commerce"
npx prisma generate
```

---

### 4. è¾“å‡ºæ ¼å¼

**æ–¹æ¡ˆ**: JSON é»˜è®¤ + `--pretty` é€‰é¡¹ï¼ˆ[ADR-004](./architecture/adr-004-json-output.md)ï¼‰

**ç†ç”±**: AIï¼ˆClaude Codeï¼‰æ˜¯æ ¸å¿ƒç”¨æˆ·ï¼Œéœ€è¦ç»“æ„åŒ–æ•°æ®

```bash
# JSON æ¨¡å¼ï¼ˆé»˜è®¤ï¼ŒAI å‹å¥½ï¼‰
bi-cli sales get --days 7
{"success": true, "data": {...}}

# Pretty æ¨¡å¼ï¼ˆäººç±»å¯è¯»ï¼‰
bi-cli sales get --days 7 --pretty
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é”€å”®æ¦‚è§ˆï¼ˆæœ€è¿‘ 7 å¤©ï¼‰              â”‚
â”‚  æ€»é”€å”®é¢:    $12,500.00           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5. å¤šç¯å¢ƒæ”¯æŒ

**æ–¹æ¡ˆ**: ä¸‰ç¯å¢ƒç‹¬ç«‹é…ç½®ï¼ˆ[ADR-005](./architecture/adr-005-multi-env.md)ï¼‰

| ç¯å¢ƒ | API URL | Auth URL |
|------|---------|----------|
| Production | https://bi-api.optima.shop | https://auth.optima.shop |
| Stage | https://bi-api-stage.optima.shop | https://auth-stage.optima.shop |
| Development | https://bi-api.optima.chat | https://auth.optima.chat |

**é…ç½®å­˜å‚¨**: `~/.optima/bi-cli/config-{env}.json`ï¼ˆåŠ å¯†ï¼‰

---

### 6. æ€§èƒ½ä¼˜åŒ–ï¼ˆğŸ”´ å¿…é¡»å®æ–½ï¼‰

**é—®é¢˜**: ç›´æ¥åœ¨ OLTP æ•°æ®åº“æ‰§è¡Œå¤æ‚åˆ†ææŸ¥è¯¢å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼ˆ[ä¸“å®¶è¯„å®¡](./expert-review.md)ï¼‰

**è§£å†³æ–¹æ¡ˆ**: é¢„èšåˆè¡¨ + å¤šå±‚ç¼“å­˜ï¼ˆ[ADR-006](./architecture/adr-006-materialized-views.md) + [æ€§èƒ½ä¼˜åŒ–æŒ‡å—](./performance-optimization.md)ï¼‰

#### é¢„èšåˆè¡¨ï¼ˆP0 - å¿…é¡»ï¼‰
- `daily_merchant_summary` - æ¯æ—¥å•†å®¶æ±‡æ€»
- `weekly_product_summary` - æ¯å‘¨å•†å“æ±‡æ€»
- `monthly_customer_summary` - æ¯æœˆå®¢æˆ·æ±‡æ€»

#### ETL ç­–ç•¥
- æ¯å°æ—¶å¢é‡æ›´æ–°
- å†å²æ•°æ®å‡†ç¡®ï¼Œä»Šæ—¥æ•°æ®å»¶è¿Ÿ â‰¤1 å°æ—¶

#### æ€§èƒ½æå‡
- **æŸ¥è¯¢æ—¶é—´**: 2-5s â†’ 50-200msï¼ˆ**10-100 å€**ï¼‰
- **OLTP è´Ÿè½½**: å‡å°‘ 80%
- **ç¼“å­˜å‘½ä¸­ç‡**: 30% â†’ 70%

#### å¤šå±‚ç¼“å­˜
```
L1: å†…å­˜ç¼“å­˜ (1 åˆ†é’Ÿ)
  â†“ miss
L2: Redis ç¼“å­˜ (5 åˆ†é’Ÿ)
  â†“ miss
L3: é¢„èšåˆè¡¨
  â†“ miss
L4: åŸå§‹è¡¨ï¼ˆfallbackï¼‰
```

---

## ğŸš€ BI åˆ†æç»´åº¦

### å•†å®¶çº§åˆ†æï¼ˆğŸª Merchantï¼‰

1. **é”€å”®åˆ†æ** (`/api/v1/sales`)
   - æ€»é”€å”®é¢ã€è®¢å•æ•°ã€å®¢å•ä»·
   - åŒæ¯”/ç¯æ¯”å¢é•¿ç‡
   - æŒ‰æ—¥æœŸ/å•†å“/åˆ†ç±»èšåˆ

2. **å•†å“åˆ†æ** (`/api/v1/products`)
   - å•†å“é”€é‡æ’è¡Œ
   - åº“å­˜å‘¨è½¬ç‡
   - ä½åº“å­˜é¢„è­¦

3. **å®¢æˆ·åˆ†æ** (`/api/v1/customers`)
   - æ–°å®¢æˆ· vs å¤è´­å®¢æˆ·
   - å®¢æˆ·ç”Ÿå‘½å‘¨æœŸä»·å€¼ï¼ˆLTVï¼‰
   - å®¢æˆ·åˆ†å±‚ï¼ˆæ–°/æ´»è·ƒ/æµå¤±/VIPï¼‰

4. **è´¢åŠ¡åˆ†æ** (`/api/v1/financial`)
   - æ€»æ”¶å…¥ã€å¹³å°æ‰‹ç»­è´¹ã€å‡€æ”¶å…¥
   - å¾…è½¬è´¦é‡‘é¢ã€å·²è½¬è´¦é‡‘é¢

5. **ç‰©æµåˆ†æ** (`/api/v1/shipping`)
   - å¹³å‡å‘è´§æ—¶é•¿ã€é…é€æ—¶é•¿
   - ç‰©æµå¼‚å¸¸ç‡

### å¹³å°çº§åˆ†æï¼ˆğŸ¢ Adminï¼‰

1. **å¹³å°æ€»è§ˆ** (`/api/v1/platform/overview`)
   - å¹³å° GMVã€è®¢å•æ•°
   - æ´»è·ƒå•†å®¶æ•°ã€æ–°å¢å•†å®¶æ•°
   - å¹³å°æ‰‹ç»­è´¹æ”¶å…¥

2. **å•†å®¶åˆ†æ** (`/api/v1/platform/merchants`)
   - å•†å®¶å¢é•¿è¶‹åŠ¿
   - å•†å®¶æ´»è·ƒåº¦æ’è¡Œ
   - å•†å®¶æµå¤±åˆ†æ

3. **è®¢é˜…åˆ†æ** (`/api/v1/platform/subscriptions`)
   - MRR/ARR
   - è®¢é˜…è®¡åˆ’åˆ†å¸ƒ
   - ç»­è´¹ç‡

---

## ğŸ“Š æŠ€æœ¯æ ˆå¯¹æ¯”

| æ¨¡å— | åç«¯æ¡†æ¶ | å‰ç«¯/CLI | æ•°æ®åº“ | è®¤è¯æ–¹å¼ |
|------|----------|----------|--------|----------|
| **commerce-backend** | FastAPI (Python) | - | PostgreSQL | user-auth |
| **user-auth** | FastAPI (Python) | - | PostgreSQL + Redis | OAuth 2.0 |
| **optima-store** | - | Next.js 14 (React) | - | Google OAuth |
| **commerce-cli** | - | TypeScript CLI | - | Device Flow |
| **optima-bi** | **Fastify (TypeScript)** | **TypeScript CLI** | **PostgreSQL (åªè¯»)** | **Device Flow** |

---

## ğŸ”„ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Claude Code â”‚ (AI åˆ†æ)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ è‡ªç„¶è¯­è¨€
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   bi-cli    â”‚ (æ•°æ®è·å–)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTPS + JWT
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bi-backend  â”‚ (æ•°æ®å¤„ç†)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ Prisma ORM (åªè¯»)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¢„èšåˆè¡¨     â”‚ â†ETLâ”€ â”‚ commerce DB â”‚
â”‚ (L3ç¼“å­˜)     â”‚       â”‚ (OLTP)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†‘
       â”‚ Redis (L2ç¼“å­˜)
       â”‚ Memory (L1ç¼“å­˜)
```

---

## âœ… å…³é”®è®¾è®¡åŸåˆ™

1. **èŒè´£åˆ†ç¦»**:
   - Claude Code: AI åˆ†æå’Œæ´å¯Ÿç”Ÿæˆ
   - bi-cli: æ•°æ®è·å–å’Œç»“æ„åŒ–è¾“å‡º
   - bi-backend: æ•°æ®æŸ¥è¯¢å’Œèšåˆè®¡ç®—

2. **AI ä¼˜å…ˆ**:
   - JSON é»˜è®¤è¾“å‡º
   - ç»Ÿä¸€å“åº”æ ¼å¼
   - å®Œæ•´çš„é”™è¯¯ä¿¡æ¯

3. **å®‰å…¨å¯é **:
   - OAuth 2.0 è®¤è¯
   - åªè¯»æ•°æ®åº“ç”¨æˆ·
   - Token åŠ å¯†å­˜å‚¨
   - è§’è‰²æƒé™éš”ç¦»

4. **æ€§èƒ½ä¼˜åŒ–**:
   - é¢„èšåˆè¡¨ï¼ˆ10-100å€æå‡ï¼‰
   - å¤šå±‚ç¼“å­˜
   - æ•°æ®åº“ç´¢å¼•
   - æŸ¥è¯¢ä¼˜åŒ–

5. **å¯æ‰©å±•æ€§**:
   - ç±»å‹å®‰å…¨ï¼ˆTypeScriptï¼‰
   - æ¨¡å—åŒ–è®¾è®¡
   - å¤šç¯å¢ƒæ”¯æŒ
   - çµæ´»çš„æŸ¥è¯¢æ¥å£

---

## ğŸ¯ ä¸‹ä¸€æ­¥

### Phase 0: æ–‡æ¡£ âœ…
- [x] PRD
- [x] æŠ€æœ¯è®¾è®¡
- [x] ç ”ç©¶æ€»ç»“
- [x] ä¸“å®¶è¯„å®¡
- [x] ADR æ–‡æ¡£
- [x] æ€§èƒ½ä¼˜åŒ–æŒ‡å—

### Phase 1: MVPï¼ˆ3-4 å‘¨ï¼‰
- [ ] bi-backend æ ¸å¿ƒåŠŸèƒ½
- [ ] bi-cli å‘½ä»¤å®ç°
- [ ] è®¤è¯é›†æˆ
- [ ] 4 ä¸ªå•†å®¶åˆ†ææ¨¡å—

### Phase 2: æ€§èƒ½ä¼˜åŒ–ï¼ˆ2 å‘¨ï¼‰
- [ ] åˆ›å»ºé¢„èšåˆè¡¨
- [ ] å®ç° ETL è„šæœ¬
- [ ] æ·»åŠ æ•°æ®åº“ç´¢å¼•
- [ ] å®ç°å¤šå±‚ç¼“å­˜
- [ ] æ€§èƒ½æµ‹è¯•

### Phase 3: å¹³å°åŠŸèƒ½ï¼ˆ2 å‘¨ï¼‰
- [ ] 5 ä¸ªå¹³å°åˆ†ææ¨¡å—
- [ ] ç®¡ç†å‘˜æƒé™æ§åˆ¶
- [ ] è·¨å•†å®¶æŸ¥è¯¢

### Phase 4: æµ‹è¯•ä¸éƒ¨ç½²ï¼ˆ1 å‘¨ï¼‰
- [ ] é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] éƒ¨ç½²åˆ° production

**æ€»è®¡**: 7-10 å‘¨ï¼ˆå·²åŒ…å«ä¸“å®¶è¯„å®¡å»ºè®®çš„æ€§èƒ½ä¼˜åŒ–ï¼‰

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [PRD](./prd.md) - äº§å“éœ€æ±‚æ–‡æ¡£
- [æŠ€æœ¯è®¾è®¡](./tech-design.md) - æŠ€æœ¯æ¶æ„è®¾è®¡
- [å¼€å‘è·¯çº¿å›¾](./roadmap.md) - å¼€å‘è®¡åˆ’
- [ä¸“å®¶è¯„å®¡æŠ¥å‘Š](./expert-review.md) - æ€§èƒ½é—®é¢˜å’Œæ”¹è¿›å»ºè®®
- [README](../README.md) - é¡¹ç›®æ¦‚è§ˆ

---

**ç»´æŠ¤è€…**: Optima BI Team
**æœ€åæ›´æ–°**: 2025-01-21
