# Optima BI CLI æµ‹è¯•æŠ¥å‘Š

**æµ‹è¯•æ—¥æœŸ:** 2025-11-21
**æµ‹è¯•ç¯å¢ƒ:** macOS, Node.js v18+

## æµ‹è¯•æ¦‚è§ˆ

| åŠŸèƒ½æ¨¡å—       | çŠ¶æ€      | è¯´æ˜                                       |
| -------------- | --------- | ------------------------------------------ |
| CLI åŸºç¡€å‘½ä»¤   | âœ… é€šè¿‡   | --help, --version æ­£å¸¸å·¥ä½œ                 |
| Auth å‘½ä»¤ç»“æ„  | âœ… é€šè¿‡   | login, logout, whoami, switch å­å‘½ä»¤å·²å®ç° |
| Sales å‘½ä»¤ç»“æ„ | âœ… é€šè¿‡   | get å­å‘½ä»¤å·²å®ç°ï¼Œæ”¯æŒ --days å’Œ --pretty  |
| è®¤è¯æ£€æŸ¥       | âœ… é€šè¿‡   | æ­£ç¡®æ£€æµ‹æœªç™»å½•çŠ¶æ€                         |
| Sales API è°ƒç”¨ | âœ… é€šè¿‡   | æˆåŠŸæŸ¥è¯¢ ClickHouse æ•°æ®                   |
| ç¼“å­˜æœºåˆ¶       | âœ… é€šè¿‡   | L1/L2 ç¼“å­˜å·¥ä½œæ­£å¸¸                         |
| æ•°æ®æ ¼å¼åŒ–     | âš ï¸ æœªæµ‹è¯• | Pretty æ ¼å¼è¾“å‡ºæœªæµ‹è¯•ï¼ˆéœ€è¦å®Œæ•´è®¤è¯æµç¨‹ï¼‰  |
| OAuth ç™»å½•     | âŒ é˜»å¡   | åç«¯ OAuth ç«¯ç‚¹æœªå®ç°ï¼ˆ404 é”™è¯¯ï¼‰          |

## è¯¦ç»†æµ‹è¯•ç»“æœ

### 1. CLI åŸºç¡€åŠŸèƒ½

```bash
âœ… npm run dev -- --help
   è¾“å‡º: æ˜¾ç¤ºå®Œæ•´å‘½ä»¤åˆ—è¡¨ï¼ˆauth, sales, config, customer, inventory, product, platformï¼‰

âœ… npm run dev -- auth --help
   è¾“å‡º: æ˜¾ç¤º auth å­å‘½ä»¤ï¼ˆlogin, logout, whoami, switchï¼‰

âœ… npm run dev -- sales --help
   è¾“å‡º: æ˜¾ç¤º sales å­å‘½ä»¤ï¼ˆgetï¼‰
```

### 2. è®¤è¯æµç¨‹

```bash
âŒ npm run dev -- auth login --env development
   é”™è¯¯: "Login failed: Request failed with status code 404"
   åŸå› : bi-backend ç¼ºå°‘ /api/v1/auth/device/code ç«¯ç‚¹

âœ… npm run dev -- sales get --days 7
   è¾“å‡º: "Not logged in. Run: bi-cli auth login"
   è¯´æ˜: æ­£ç¡®æ£€æµ‹æœªç™»å½•çŠ¶æ€
```

### 3. Sales API åŠŸèƒ½æµ‹è¯•

ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆç»•è¿‡è®¤è¯ï¼‰éªŒè¯ï¼š

```bash
âœ… node test-sales.js
   ç»“æœ:
   - æ€»æ”¶å…¥: Â¥49,267.49
   - è®¢å•æ•°: 22
   - å¹³å‡è®¢å•ä»·å€¼: Â¥2,239.43
   - ç‹¬ç«‹å®¢æˆ·: 22
   - æŸ¥è¯¢æ—¶é—´: 20msï¼ˆé¦–æ¬¡æŸ¥è¯¢ï¼‰
   - ç¼“å­˜å‘½ä¸­æ—¶é—´: <2ms
```

**æ•°æ®éªŒè¯:**

- âœ… ClickHouse è¿æ¥æ­£å¸¸
- âœ… å‚æ•°åŒ–æŸ¥è¯¢å·¥ä½œæ­£å¸¸
- âœ… æ—¥æœŸèŒƒå›´è¿‡æ»¤æ­£ç¡®ï¼ˆæ”¯æŒ 1-365 å¤©ï¼‰
- âœ… èšåˆè®¡ç®—å‡†ç¡®ï¼ˆsumMerge, countMerge, avgMergeï¼‰
- âœ… å¤šå±‚ç¼“å­˜å·¥ä½œæ­£å¸¸ï¼ˆ126x æ€§èƒ½æå‡ï¼‰

### 4. API ç«¯ç‚¹æµ‹è¯•

```bash
âœ… GET /health
   å“åº”: {"status": "ok", "clickhouse": "connected"}

âœ… GET /api/v1/sales?days=7
   å“åº”: åŒ…å« summary å’Œ daily æ•°æ®
   ç¼“å­˜: æ”¯æŒï¼ˆmeta.cachedï¼‰
   æ€§èƒ½: é¦–æ¬¡ 224msï¼Œç¼“å­˜å‘½ä¸­ 1.78ms

âŒ POST /api/v1/auth/device/code
   å“åº”: 404 Not Found
   åŸå› : ç«¯ç‚¹æœªå®ç°
```

## é˜»å¡é—®é¢˜

### ğŸš¨ å…³é”®é˜»å¡ï¼šOAuth åç«¯æœªå®ç°

**å½±å“èŒƒå›´:**

- âŒ æ— æ³•ç™»å½•
- âŒ æ— æ³•è·å–çœŸå® merchant_id
- âŒ æ— æ³•æµ‹è¯•å®Œæ•´çš„ç«¯åˆ°ç«¯æµç¨‹
- âŒ sales å‘½ä»¤è™½ç„¶å®ç°ä½†æ— æ³•æ­£å¸¸ä½¿ç”¨

**éœ€è¦å®ç°çš„ç«¯ç‚¹:**

1. `POST /api/v1/auth/device/code` - å‘èµ·è®¾å¤‡æˆæƒæµç¨‹
2. `POST /api/v1/auth/device/token` - è½®è¯¢è·å– access token
3. `GET /api/v1/auth/me` - è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
4. `POST /api/v1/auth/refresh` - åˆ·æ–° tokenï¼ˆå¯é€‰ï¼‰

**éœ€è¦æ·»åŠ çš„ä¸­é—´ä»¶:**

- JWT éªŒè¯ä¸­é—´ä»¶ï¼ˆéªŒè¯ Authorization headerï¼‰
- Merchant ID æå–ï¼ˆä» JWT payloadï¼‰

## ä»£ç è´¨é‡

### å·²å®Œæˆ

- âœ… TypeScript ç±»å‹å®šä¹‰å®Œæ•´
- âœ… é”™è¯¯å¤„ç†è§„èŒƒ
- âœ… ESLint æ£€æŸ¥é€šè¿‡ï¼ˆæ—  warnings/errorsï¼‰
- âœ… ä»£ç æ ¼å¼åŒ–ï¼ˆPrettierï¼‰
- âœ… Git hooks æ­£å¸¸å·¥ä½œ

### å¾…æ”¹è¿›

- âš ï¸ ç¼ºå°‘å•å…ƒæµ‹è¯•
- âš ï¸ ç¼ºå°‘é›†æˆæµ‹è¯•
- âš ï¸ ç¼ºå°‘ API æ–‡æ¡£ï¼ˆOpenAPIï¼‰

## å»ºè®®ä¼˜å…ˆçº§

### ğŸ”´ P0ï¼ˆé˜»å¡æ€§ï¼‰

1. **å®ç° OAuth 2.0 åç«¯** - è§£é”å®Œæ•´æµç¨‹
   - Device Flow ç«¯ç‚¹
   - JWT ç”Ÿæˆå’ŒéªŒè¯
   - ç”¨æˆ·èº«ä»½ç®¡ç†

### ğŸŸ¡ P1ï¼ˆé‡è¦ï¼‰

2. **æ·»åŠ  JWT è®¤è¯ä¸­é—´ä»¶** - ä¿æŠ¤ API
   - éªŒè¯ access token
   - æå– merchant_id
   - å¤„ç† token è¿‡æœŸ

3. **å®Œå–„é”™è¯¯å¤„ç†** - æå‡ç”¨æˆ·ä½“éªŒ
   - Token è¿‡æœŸè‡ªåŠ¨åˆ·æ–°
   - å‹å¥½çš„é”™è¯¯æç¤º
   - é‡è¯•æœºåˆ¶

### ğŸŸ¢ P2ï¼ˆå¢å¼ºï¼‰

4. **æ·»åŠ æµ‹è¯•è¦†ç›–** - ä¿è¯è´¨é‡
   - å•å…ƒæµ‹è¯•ï¼ˆservices, routesï¼‰
   - é›†æˆæµ‹è¯•ï¼ˆç«¯åˆ°ç«¯ï¼‰
   - Mock ClickHouse/Redis

5. **æ›´å¤šåˆ†æç»´åº¦** - æ‰©å±•åŠŸèƒ½
   - å®¢æˆ·åˆ†æï¼ˆRFM, ç•™å­˜ç‡ï¼‰
   - å•†å“åˆ†æï¼ˆé”€é‡æ’è¡Œï¼‰
   - åº“å­˜åˆ†æï¼ˆå‘¨è½¬ç‡ï¼‰

## ç»“è®º

**å½“å‰çŠ¶æ€:** âœ… åŸºç¡€æ¶æ„å®Œæ•´ï¼Œæ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼Œä½†ç¼ºå°‘è®¤è¯åç«¯å¯¼è‡´æ— æ³•çœŸæ­£ä½¿ç”¨

**å¯ç”¨æ€§:**

- åç«¯ API: 70% å®Œæˆï¼ˆç¼ºå°‘ OAuthï¼‰
- CLI å·¥å…·: 90% å®Œæˆï¼ˆåŠŸèƒ½é½å…¨ï¼Œç­‰å¾…åç«¯ï¼‰
- ç«¯åˆ°ç«¯æµç¨‹: 0% å¯ç”¨ï¼ˆé˜»å¡åœ¨è®¤è¯ï¼‰

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨:**
å¿…é¡»å…ˆå®ç° OAuth 2.0 åç«¯ï¼Œæ‰èƒ½è¿›è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•å’Œç”¨æˆ·éªŒæ”¶æµ‹è¯•ã€‚
